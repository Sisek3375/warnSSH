#!/bin/bash
notify-send "âš¡ warnSSH est activÃ© !"
echo "warnSSH est activÃ©, faites Ctrl+C pour arrÃªter le scan du port SSH"

log_file="$HOME/warnssh.log"
touch $log_file

# Phase d'extraction
extract_info() {
  
  # Extraction de la date et heure
  datetime=$(echo "$line" | grep -oP '^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}')
  
  # Extraction de l'utilisateur
  if [[ "$line" == *"for "* ]]; then
    user=$(echo "$line" | grep -oP 'for \K\w+')
  elif [[ "$line" == *"user "* ]]; then
    user=$(echo "$line" | grep -oP 'user \K[^(]+' | tr -d ' ')
  elif [[ "$line" == *"ruser="* ]]; then
    user=$(echo "$line" | grep -oP 'ruser=\K[^ ]+')
  fi
  
  # Extraction de l'IP
  if [[ "$line" == *"from "* ]]; then
    ip=$(echo "$line" | grep -oP 'from \K[0-9.]+')
  elif [[ "$line" == *"rhost="* ]]; then
    ip=$(echo "$line" | grep -oP 'rhost=\K[^ ]+')
  fi
 
  # Formatage de la date
  if [[ -n "$datetime" ]]; then
    formatted_date=$(date -d "$datetime" "+%d/%m/%Y %H:%M:%S")
  else
    formatted_date="Date inconnue"
  fi
  
  # Construction de base_info
  base_info="ðŸ•’ $formatted_date"
  [[ -n "$ip" ]] && base_info="$base_info\nðŸŒ IP: $ip"
  [[ -n "$user" ]] && base_info="$base_info\nðŸ‘¤ User: $user"
  
  echo "$base_info"
}

# Phase de parsing
tail -f -n 0 /var/log/auth.log | while read line; do
  if [[ "$line" == *"sshd"* ]]; then
    # Extraction des informations communes
    base_info=$(extract_info "$line")
    
    # Switch case
    case "$line" in
        *"Accepted password"*|*"Accepted publickey"*)
            notify-send "âœ… Connexion SSH rÃ©ussie" "$base_info\nðŸ“‹ Statut: Authentification rÃ©ussie"
            echo "$(date "+%d/%m/%Y %H:%M:%S") | Connexion SSH rÃ©ussie" >> $log_file
            ;;
        *"Failed password"*)
            notify-send "âŒ Ã‰chec d'authentification SSH" "$base_info\nðŸ“‹ Statut: Mot de passe incorrect" 
            echo "$(date "+%d/%m/%Y %H:%M:%S") | Ã‰chec d'authentification SSH" >> $log_file
            ;;
        *"Invalid user"*)
            notify-send "âš ï¸ Tentative avec utilisateur invalide" "$base_info\nðŸ“‹ Statut: Utilisateur inexistant"
            echo "$(date "+%d/%m/%Y %H:%M:%S") | Tentative avec utilisateur invalide" >> $log_file
	    ;;
        *"Did not receive identification string"*)
            notify-send "ðŸš« Connexion SSH abandonnÃ©e" "$base_info\nðŸ“‹ Statut: Identification Ã©chouÃ©e"
            echo "$(date "+%d/%m/%Y %H:%M:%S") | Connexion SSH abandonnÃ©e" >> $log_file
	    ;;
        *"Connection from"*"closed"*)
            notify-send "ðŸ”’ Connexion SSH fermÃ©e" "$base_info\nðŸ“‹ Statut: Connexion interrompue"
            echo "$(date "+%d/%m/%Y %H:%M:%S") | Connexion SSH fermÃ©e" >> $log_file
            ;;
        *"Received disconnect"*)
            notify-send "ðŸ“¡ DÃ©connexion SSH" "$base_info\nðŸ“‹ Statut: Client dÃ©connectÃ©"
            echo "$(date "+%d/%m/%Y %H:%M:%S") | DÃ©connexion SSH" >> $log_file
	    ;;
        *"pam_unix(sshd:auth): authentication failure"*)
            notify-send "ðŸ” Ã‰chec d'authentification PAM" "$base_info\nðŸ“‹ Statut: Authentification PAM Ã©chouÃ©e"
            echo "$(date "+%d/%m/%Y %H:%M:%S") | Ã‰chec d'authentification PAM" >> $log_file
	    ;;
    esac
  fi
done
